const fetch = require('node-fetch')
const ALLOWED={stack:['backend','frontend'],level:['debug','info','warn','error','fatal'],pkgBackend:['cache','controller','cron_job','db','domain','handler','repository','route','service'],pkgFrontend:['api','component','hook','page','state','style'],pkgBoth:['auth','config','middleware','utils']}
const send=(t,b)=>fetch('http://20.244.56.144/eva1uation-service/logs',{method:'POST',headers:{'content-type':'application/json',authorization:`Bearer ${t||process.env.LOG_TOKEN||''}`},body:JSON.stringify(b)}).catch(()=>{})
module.exports=(opts={token:process.env.LOG_TOKEN})=>async(req,res,next)=>{try{const body=req.body||{};const stack=(body.stack||process.env.STACK||'backend').toString().toLowerCase();const level=(body.level||process.env.LEVEL||'info').toString().toLowerCase();let pkg=(body.package||process.env.PACKAGE||'middleware').toString().toLowerCase();if(!ALLOWED.stack.includes(stack)||!ALLOWED.level.includes(level))return next();const valid=stack==='backend'?ALLOWED.pkgBackend.concat(ALLOWED.pkgBoth):ALLOWED.pkgFrontend.concat(ALLOWED.pkgBoth);if(!valid.includes(pkg))pkg='middleware';const msg=body.message||`${req.method} ${req.originalUrl}`;send(opts.token,{stack,level,package:pkg,message:msg})}catch(e){}next()}
